import { TestBed } from '@angular/core/testing';
import { DebtConsolidationPDFExportService } from './debt-consolidation-pdf-export.service';
import { FundingParameters, FundingResults, DebtConsolidationParameters, DebtConsolidationResults, LoanToConsolidate } from '../../_api';

describe('DebtConsolidationPDFExportService', () => {

  let aDebtConsolidationPDFExportService: DebtConsolidationPDFExportService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    aDebtConsolidationPDFExportService = TestBed.inject(DebtConsolidationPDFExportService);
  });


  it('DebtConsolidation gain deficit table must be correctly formatted', () => {
    const debtConsolidationParameters: DebtConsolidationParameters = {loans: [], funding_fees: { file_management_fees: 2, broker_fees: 3}, project: { type: 'DEBT_CONSOLIDATION', expenses: {other_expenses: 1 } }};
    const debtConsolidationResults: DebtConsolidationResults = {insurance_gain: 111, interests_gain: 222, total_gain:333, loans_remaining_costs: [{capital: 1000, insurance_cost: 500, interest_cost:350, ira: {type: 'NEGOCIATED', value: 170}}], funding_plan: {status: 'OPTIMAL', summary: { effective_maximal_monthly_payment: 1, duration_months: 240, total_interests: 2, total_insurances: 3, total_guaranty: 4, total_preamortizations: 5, final_debt_ratio: 33, total_personal_funding: 5000 }}};

    aDebtConsolidationPDFExportService.aParams = debtConsolidationParameters;
    aDebtConsolidationPDFExportService.aDebtConsolidationResults = debtConsolidationResults;

    // console.log(JSON.stringify(aDebtConsolidationPDFExportService.generateGainDefinitTable('y', 'b', 'g', 'r')));
    const expectedResult = JSON.stringify([{table:{widths:[25,250,100],body:[[{text:'',fillColor:'r',alignment:'center',color:'white'},{text:'Intérêts restants sur le prêt racheté',fillColor:'r',color:'white'},{text:'350,00 €',fillColor:'r',alignment:'right',color:'white'}],[{text:'+',fillColor:'r',alignment:'center',color:'white'},{text:'Assurance(s) restante(s) sur le prêt racheté',fillColor:'r',color:'white'},{text:'500,00 €',fillColor:'r',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Intérets du nouveau plan',fillColor:'y',color:'white'},{text:'2,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Assurance(s) du nouveau plan',fillColor:'y',color:'white'},{text:'3,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Indemnités de remboursement anticipées',fillColor:'y',color:'white'},{text:'170,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Nouvelle garantie',fillColor:'y',color:'white'},{text:'4,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Dépense ou frais annexes',fillColor:'y',color:'white'},{text:'1,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Frais de dossier',fillColor:'y',color:'white'},{text:'2,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'-',fillColor:'y',alignment:'center',color:'white'},{text:'Frais de courtage',fillColor:'y',color:'white'},{text:'3,00 €',fillColor:'y',alignment:'right',color:'white'}],[{text:'=',fillColor:'b',alignment:'center',color:'white'},{text:'Gain',fillColor:'b',color:'white'},{text:'665,00 €',fillColor:'b',alignment:'right',color:'white'}]]},layout:'noBorders'}]);
    expect(JSON.stringify(aDebtConsolidationPDFExportService.generateGainDefinitTable('y', 'b', 'g', 'r'))).toBe(expectedResult);
  });


  it('DebtConsolidation balance table must be correctly formatted', () => {
    const loansToConsolidate: LoanToConsolidate[] = [{ yearly_rate: 1, duration_months: 240, initial_capital: 200000, insurances: [{type: 'INITIAL_CAPITAL', rate: 0.4, quota: 100.0, mandatory: true}, {type: 'INITIAL_CAPITAL', rate: 0.3, quota: 100.0, mandatory: true}], first_monthly_payment_date: '2019-06-24T14:15:22Z', ira: {type: 'LEGAL'} } ];
    const debtConsolidationParameters: DebtConsolidationParameters = {loans: [], funding_fees: { file_management_fees: 2, broker_fees: 3}, project: { type: 'DEBT_CONSOLIDATION', loans_to_consolidate: loansToConsolidate,  expenses: {other_expenses: 1} }};
    const debtConsolidationResults: DebtConsolidationResults = {insurance_gain: 111, interests_gain: 222, total_gain:333, loans_remaining_costs: [{capital: 1000, insurance_cost: 500, interest_cost:350, ira: {type: 'NEGOCIATED', value: 170}}], funding_plan: {status: 'OPTIMAL', summary: { effective_maximal_monthly_payment: 1, duration_months: 240, total_interests: 2, total_insurances: 3, total_guaranty: 4, total_preamortizations: 5, final_debt_ratio: 33, total_personal_funding: 5000 }}};

    aDebtConsolidationPDFExportService.aParams = debtConsolidationParameters;
    aDebtConsolidationPDFExportService.aDebtConsolidationResults = debtConsolidationResults;

    // console.log(JSON.stringify(aDebtConsolidationPDFExportService.generateBalanceTable(debtConsolidationParameters.project, debtConsolidationResults, 'y', 'b', 'g', 'p')));
    const expectedResult = JSON.stringify([{table:{widths:[20,170,'auto',100,'auto'],headerRows:2,body:[[{text:'',fillColor:'y',alignment:'center',color:'white'},{text:'Capital racheté',fillColor:'y',color:'white'},{text:'1 000,00 €',fillColor:'y',alignment:'right',color:'white'},{text:'Total projet',rowSpan:2,fillColor:'y',color:'white'},{text:'1 001,00 €',rowSpan:2,fillColor:'y',alignment:'right',color:'white'}],[{text:'+',fillColor:'y',alignment:'center',color:'white'},{text:'Dépense ou frais annexes',fillColor:'y',color:'white'},{text:'1,00 €',fillColor:'y',alignment:'right',color:'white'},{text:'',fillColor:'y',color:'white'},{text:'',fillColor:'y',color:'white'}],[{text:'+',fillColor:'b',alignment:'center',color:'white'},{text:'Frais de courtage',fillColor:'b',color:'white'},{text:'3,00 €',fillColor:'b',alignment:'right',color:'white'},{text:'Total frais',rowSpan:4,fillColor:'b',color:'white'},{text:'179,00 €',rowSpan:4,fillColor:'b',alignment:'right',color:'white'}],[{text:'+',fillColor:'b',alignment:'center',color:'white'},{text:'Frais de dossier',fillColor:'b',color:'white'},{text:'2,00 €',fillColor:'b',alignment:'right',color:'white'},{text:'',fillColor:'b',color:'white'},{text:'',fillColor:'b',color:'white'}],[{text:'+',fillColor:'b',alignment:'center',color:'white'},{text:'Montant des IRA',fillColor:'b',color:'white'},{text:'170,00 €',fillColor:'b',alignment:'right',color:'white'},{text:'',fillColor:'b',color:'white'},{text:'',fillColor:'b',color:'white'}],[{text:'+',fillColor:'b',alignment:'center',color:'white'},{text:'Frais de garanties',fillColor:'b',color:'white'},{text:'4,00 €',fillColor:'b',alignment:'right',color:'white'},{text:'',fillColor:'b',color:'white'},{text:'',fillColor:'b',color:'white'}],[{text:'-',fillColor:'g',alignment:'center',color:'white'},{text:'Apport personnel',fillColor:'g',color:'white'},{text:'5 000,00 €',fillColor:'g',alignment:'right',color:'white'},{text:''},{text:''}],[{text:'=',fillColor:'p',alignment:'center',color:'white'},{text:'Montant financé',fillColor:'p',color:'white'},{text:'-3 820,00 €',fillColor:'p',alignment:'right',color:'white'},{text:''},{text:''}]]},layout:'noBorders'}]);
    expect(JSON.stringify(aDebtConsolidationPDFExportService.generateBalanceTable(debtConsolidationParameters.project, debtConsolidationResults, 'y', 'b', 'g', 'p'))).toBe(expectedResult);
  });


  it('DebtConsolidation summary must be correctly formatted', () => {
    const loansToConsolidate: LoanToConsolidate[] = [{ yearly_rate: 1, duration_months: 240, initial_capital: 200000, insurances: [{type: 'INITIAL_CAPITAL', rate: 0.4, quota: 100.0, mandatory: true}, {type: 'INITIAL_CAPITAL', rate: 0.3, quota: 100.0, mandatory: true}], first_monthly_payment_date: '2019-06-24T14:15:22Z', ira: {type: 'LEGAL'} }];
    const debtConsolidationParameters: DebtConsolidationParameters = {loans: [], funding_fees: { file_management_fees: 2, broker_fees: 3}, project: { type: 'DEBT_CONSOLIDATION', loans_to_consolidate: loansToConsolidate, expenses: {other_expenses: 1} }};
    const aFundingResults: FundingResults = { status: 'OPTIMAL', loans: [{ type: 'FREE_LOAN', yearly_rate: 0, duration_months: 180, amount: 200000, amortizations: [], interests: [], insurances: [], released_amounts: [], remaining_capital: [], preamortizations: [], interests_cost: 0, insurance_cost: 0, preamortization_cost: 0 } ], summary: { effective_maximal_monthly_payment: 1, duration_months: 240, total_interests: 2, total_insurances: 3, total_guaranty: 4, total_preamortizations: 5, final_debt_ratio: 33, total_personal_funding: 5000 } };
    const debtConsolidationResults: DebtConsolidationResults = {insurance_gain: 111, interests_gain: 222, total_gain:333, loans_remaining_costs: [{capital: 1000, insurance_cost: 500, interest_cost:350, ira: {type: 'NEGOCIATED', value: 170}}], funding_plan: aFundingResults };

    aDebtConsolidationPDFExportService.aParams = debtConsolidationParameters;
    aDebtConsolidationPDFExportService.aDebtConsolidationResults = debtConsolidationResults;

    // console.log(JSON.stringify(aDebtConsolidationPDFExportService.summaryDebtConsolidation()));
    const expectedResult = JSON.stringify([{style:'h2',text:'Détail de l\'opération de rachat',alignment:'center',pageOrientation:'landscape',pageBreak:'before'},{style:'bigLineBreak',text:''},{style:'bigLineBreak',text:''},{style:'h3centerbold',width:'100%',text:'Caractéristiques du prêt racheté et assurance(s) associée(s)'},{style:'table',headerRows:1,widths:['100%'],table:{body:[[{style:'thead',text:'Numéro du prêt',alignment:'center'},{style:'thead',text:'Durée',alignment:'center'},{style:'thead',text:'Taux',alignment:'center'},{style:'thead',text:'Capital initial',alignment:'center'},{style:'thead',text:'Capital restant dû',alignment:'center'},{style:'thead',text:'Intérets restants',alignment:'center'},{style:'thead',text:'Assurance restante',alignment:'center'},{style:'thead',text:'Date de début',alignment:'center'},{style:'thead',text:'Type d\'IRA',alignment:'center'},{style:'thead',text:'Montant des IRA',alignment:'center'}],[1,240,'1,00%','200 000,00 €','1 000,00 €','350,00 €','500,00 €','24 juin 2019','Légales','170,00 €']],widths:['*','*','*','*','*','*','*','*','*','*','*']}},{columns:[{width:'20%',text:''},{style:'table',margin:[0,0,0,0],headerRows:1,widths:['auto'],table:{body:[[{style:'thead',text:'Numéro du prêt',alignment:'center'},{style:'thead',text:'Type de prêt',alignment:'center'},{style:'thead',text:'Type d\'assurance',alignment:'center'},{style:'thead',text:'Taux',alignment:'center'},{style:'thead',text:'Quotité',alignment:'center'},{style:'thead',text:'Obligatoire ?',alignment:'center'},{style:'thead',text:'Risques couverts',alignment:'center'},{style:'thead',text:'Emprunteur',alignment:'center'},{style:'thead',text:'Assureur',alignment:'center'}],[1,'Prêt racheté','Capital initial',0.4,100,'Oui','','',''],[1,'Prêt racheté','Capital initial',0.3,100,'Oui','','','']]}},{width:'*',text:''}]},{style:'bigLineBreak',text:''},{style:'bigLineBreak',text:''},{style:'bigLineBreak',text:''},{style:'h3centerbold',width:'100%',text:'Bilan de l\'opération de rachat'},{style:'bigLineBreak',text:''},{style:'bigLineBreak',text:''},{columns:[{width:175,text:''},{table:{widths:[25,250,100],body:[[{text:'',fillColor:'#416fb8',alignment:'center',color:'white'},{text:'Intérêts restants sur le prêt racheté',fillColor:'#416fb8',color:'white'},{text:'350,00 €',fillColor:'#416fb8',alignment:'right',color:'white'}],[{text:'+',fillColor:'#416fb8',alignment:'center',color:'white'},{text:'Assurance(s) restante(s) sur le prêt racheté',fillColor:'#416fb8',color:'white'},{text:'500,00 €',fillColor:'#416fb8',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Intérets du nouveau plan',fillColor:'#e0a239',color:'white'},{text:'2,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Assurance(s) du nouveau plan',fillColor:'#e0a239',color:'white'},{text:'3,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Indemnités de remboursement anticipées',fillColor:'#e0a239',color:'white'},{text:'170,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Nouvelle garantie',fillColor:'#e0a239',color:'white'},{text:'4,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Dépense ou frais annexes',fillColor:'#e0a239',color:'white'},{text:'1,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Frais de dossier',fillColor:'#e0a239',color:'white'},{text:'2,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'-',fillColor:'#e0a239',alignment:'center',color:'white'},{text:'Frais de courtage',fillColor:'#e0a239',color:'white'},{text:'3,00 €',fillColor:'#e0a239',alignment:'right',color:'white'}],[{text:'=',fillColor:'#70b484',alignment:'center',color:'white'},{text:'Gain',fillColor:'#70b484',color:'white'},{text:'665,00 €',fillColor:'#70b484',alignment:'right',color:'white'}]]},layout:'noBorders'},{width:'*',text:''}]}]);
    expect(JSON.stringify(aDebtConsolidationPDFExportService.summaryDebtConsolidation())).toBe(expectedResult);
  });

});